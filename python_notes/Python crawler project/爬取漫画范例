from selenium import webdriver
from selenium.webdriver.edge.options import Options
from selenium.webdriver.common.by import By
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
from bs4 import BeautifulSoup
import time
import os
import requests

# æ— å¤´æ¨¡å¼é…ç½®ï¼ˆé™é»˜è¿è¡Œï¼‰
edge_options = Options()
edge_options.add_argument('--headless')
edge_options.add_argument('--disable-gpu')
edge_options.add_argument("user-agent=Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.110 Safari/537.36")


# å¯åŠ¨æµè§ˆå™¨
driver = webdriver.Edge(options=edge_options)

def get_latest_chapter(comic_id=533395):  # å¦–ç¥è®°ID
    """è·å–æœ€æ–°ç« èŠ‚é“¾æ¥åŠæ ‡é¢˜"""
    main_url = f"http://ac.qq.com/Comic/comicInfo/id/533395"
    driver.get(main_url)
    WebDriverWait(driver, 15).until(
        EC.presence_of_element_located((By.CSS_SELECTOR, 'ol.works-chapter-list'))
    )
    
    # è·å–æœ€æ–°ç« èŠ‚
    latest_chapter = driver.find_element(By.CSS_SELECTOR, 'ol.works-chapter-list > li:last-child a')
    chapter_title = latest_chapter.get_attribute('title').replace(' ', '_')
    chapter_url = latest_chapter.get_attribute('href')
    
    print(f"ğŸ“– æ‰¾åˆ°æœ€æ–°ç« èŠ‚: {chapter_title} - {chapter_url}")
    return chapter_title, chapter_url
    

def scroll_to_load_images():
    """æ¨¡æ‹Ÿæ»šåŠ¨è§¦å‘å›¾ç‰‡åŠ¨æ€åŠ è½½"""
    # ç­‰å¾…æ¼«ç”»å®¹å™¨åŠ è½½
    WebDriverWait(driver, 10).until(
        EC.presence_of_element_located((By.ID, 'comicContain'))
    )
    
    # é€æ­¥æ»šåŠ¨é¡µé¢ï¼ˆæ¯æ¬¡æ»šåŠ¨ä¸€å±é«˜åº¦ï¼‰
    scroll_height = driver.execute_script("return document.body.scrollHeight")
    for i in range(0, scroll_height, 800):
        driver.execute_script(f"window.scrollTo(0, {i});")
        time.sleep(0.5)  # æ»šåŠ¨é—´éš”é˜²å°IP

def download_images(chapter_title):
    """ä¸‹è½½ç« èŠ‚æ‰€æœ‰å›¾ç‰‡"""
    # åˆ›å»ºæ–‡ä»¶å¤¹
    if not os.path.exists(chapter_title):
        os.makedirs(chapter_title)
    
    # è§£æå›¾ç‰‡é“¾æ¥
    imgs = driver.find_elements(By.CSS_SELECTOR, '#comicContain li img')
    for idx, img in enumerate(imgs):
        img_url = img.get_attribute('src')  # åŠ¨æ€åŠ è½½åsrcå˜ä¸ºçœŸå®åœ°å€
        if 'gif' in img_url:  # è·³è¿‡å¹¿å‘Šå ä½å›¾
            continue
        
        # ä¸‹è½½å›¾ç‰‡
        img_data = requests.get(img_url).content
        with open(f"{chapter_title}/{idx+1}.jpg", 'wb') as f:
            f.write(img_data)
        print(f"å·²ä¸‹è½½ï¼š{chapter_title}/{idx+1}.jpg")

# ä¸»æµç¨‹
if __name__ == "__main__":
    try:
        title, url = get_latest_chapter()
        driver.get(url)              # è¿›å…¥ç« èŠ‚é¡µ
        scroll_to_load_images()      # æ»šåŠ¨åŠ è½½å›¾ç‰‡
        download_images(title)       # ä¸‹è½½å›¾ç‰‡
    finally:
        driver.quit()                # ç¡®ä¿å…³é—­æµè§ˆå™¨